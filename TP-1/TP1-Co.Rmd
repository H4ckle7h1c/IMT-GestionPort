---
title: "Gestion de Portefeuille"
subtitle: "TP-1: Analyse du CAC40"
date: "Février-Mars 2021"
output: 
  pdf_document:
    keep_tex: true
    fig_caption: yes
    latex_engine: pdflatex
geometry: margin=1in

header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage{amsmath}
  - \usepackage{amsfonts}
  - \usepackage{amssymb}
  - \usepackage[cyr]{aeguill}
  - \usepackage[french]{babel}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-libraries, include=FALSE, echo=TRUE}
library(lubridate)
library(Hmisc)
library(tseries)
library(timeSeries)
library(reshape2)
library(ggplot2)


get.src.folder <- function() {
  path.expand("../GP/src")
}

get.data.folder <- function() {
  path.expand("../GP/data")
}

source(file.path(get.src.folder(), 'utils.R'))
source(file.path(get.src.folder(), 'FileUtils.R'))
```


## Les données

On charge les séries de rendements pour l'indice et les composants de l'indice.

```{r, get-data, warning=FALSE, echo=TRUE}

tickers <- NULL
  ts.all <- get.all.ts(
    'CAC40', tickers, returns = TRUE,
    dt.start = dmy('01Jul2007'), combine = T)
  
  # remove Valeo - bad data
  ts.all <- ts.all[,-17]
  
  # keep good data window
  ts.all <- window(ts.all, dmy('01Jul2007'), 
                   dmy('01Jan2009'))
  
  # merge with cac40 index
  cac.index <- get.ts('CAC40', 'fchi')

  cac.ret <- returns(cac.index)
  names(cac.ret) <- 'CAC40'
  ts.all <- removeNA(cbind(ts.all, cac.ret))
```

```{r, plot-cac-1, echo=TRUE, fig.height=4, echo=TRUE}
plot(ts.all[, c(1,2,3)], main='Daily return')
```

Puis on filtre les points suspects: rendements supérieur à 8 s.d.

```{r, filter, warning=FALSE, echo=TRUE} 
  # flag bad data points: > * \sigma
  good.limit <- 8*apply(ts.all, 2, sd)
  
  ts.bad <- ts.all*FALSE
  for(j in seq(ncol(ts.bad))) {
    ts.bad[,j] <- abs(ts.all[,j]) > good.limit[j]
  }
  good.index <- !apply(ts.bad,1,any)
  ts.all <- ts.all[good.index,]
```

Finalement, on calcule les rendements hebdomadaires:
  
```{r, weekly-return, echo=TRUE} 
  # aggregate returns by week
  by <- timeSequence(from=start(ts.all), 
                     to=end(ts.all), by='week')
  ts.all.weekly <- aggregate(ts.all, by, sum)

  ts.stocks <- ts.all.weekly[,-40]
  ts.index <- ts.all.weekly[,40]
```
```{r, plot-cac-2, echo=TRUE, fig.height=4}
plot(ts.index, main='Weekly return')
```

## Calcul de correlation

+ Calculer la matrice de corrélation des actions de l\'indice. 


+ Rechercher des actions fortement corrélées et d'autres qui semblent indépendantes. 
Justifier ces observations en considérant la nature des entreprises.

+ Choisir 3 titres, et reproduire la figure 3.5, page 35 du manuel de B. Pfaff.
Commenter les résultats obtenus.


## Analyse en composantes principales


```{r}
  pca <- prcomp(ts.stocks)
```
Les 6 premiers facteurs expliquent 80\% de la variance.


```{r}
pc.var <- pca$sdev[1:6]^2/sum(pca$sdev^2)
names(pc.var) <- paste('PC-', seq(6),sep='')
```

```{r}
barplot(pc.var, ylab='% Variance')
```


Les actions du CAC40 sont assez uniformement exposées au premier
facteur, que l'on peut de ce fait interpréter comme le "marché" 

```{r}
melted <- melt(pca$rotation[,1:4])

  ggplot(data=melted) +
    geom_bar(aes(x=Var1, y=value),
             stat="identity") +
    facet_wrap(~Var2)
```

Projection des rendements hebdomadaires sur le 4 premières
  composantes principales}
  
Cette interprétation est validée en construisant une serie
chronologique du facteur 1 et en la comparant à l'indice lui même 

```{r, echo=TRUE}

  pc.1 <- ts.stocks %*% pca$rotation[,1]
  ts.pc.1 <- timeSeries(pc.1, time(ts.stocks))
```

```{r, echo=TRUE}
  plot(cbind(scale(ts.pc.1), scale(ts.index)), plot.type='single',
       col=c('blue', 'red'), ylab='Rendement hebdomadaire normalisé')
  legend('bottomleft', c('PC 1', 'CAC 40 index'), lwd=2,
         col=c('blue', 'red'), cex=.6)
```

Rendement hebdomadaire de l'indice CAC 40 et premier facteur.

Les valeurs du secteur bancaire et des assurances se projettent
fortement sur la deuxième composante principale:

```{r, echo=TRUE}
print(sort(abs(pca$rotation[,4])))
```

```{r, echo=TRUE}
print(sort(pca$rotation[,4]))
```


On peut donc interpréter ce deuxième axe comme un facteur de rendement
spécifique au
secteur "bancassurance", qui est un élément original du paysage
bancaire Français.



